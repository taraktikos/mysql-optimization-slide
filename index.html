<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Оптимізація MySql</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Hakim El Hattab">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/serif.css" id="theme">
		<link rel="stylesheet" href="css/custom.css" >

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', use the PDF print sheet -->
		<script>
			document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>
		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">

				<section>
                    <img src="img/mysql.png"/>
                    <h2>Performance Optimization</h2>
				</section>

                <section data-markdown>
                    ## План

                    * Іторія MySql
                    * Архітектура
                    * Тюнінг mysql
                    * Утиліти
                    * Запити
                    * Поради
                </section>

                <section>
                    <section>
                        <h2>Іторія MySql</h2>
                        <p>Изобретателем MySQL является Михаил Видениус aka Monty из шведской компании TcX. В 1979 году он разработал средство управления базами данных, которое называлось UNIREG.</p>
                        <p><strong>mSQL (она же MiniSQL)</strong> — легковесная клиент-серверная реляционная СУБД, выпускаемая компанией Hughes Technologies. (Створена в 1994 році)</p>
                        <p>В TcX взяли за основу UNIREG и использовали утилиты сторонних разработчиков для mSQL, написали API для своей системы, который изначально сильно совпадал с API для mSQL.</p>
                        <p> Таким образом, в мае 1995 года у компании имелась база данных MySQL 1.0 полностью удовлетворяющая потребностям компании.</p>
                        <p>Что касается названия, то Видениус говорит об этом так: «До конца не ясно, откуда идет название MySQL. В ТсХ базовый каталог, а также значительное число библиотек и утилит в течение десятка лет имели префикс “my„. Вместе с тем мою дочь (которая на несколько лет младше) тоже зовут My. Поэтому остается тайной, какой из двух источников дал название MySQL». </p>
                        <p>MySQL виникла як спроба застосувати mSQL до власних розробок компанії: таблиць, для яких використовувалися ISAM — підпрограми низького рівня. У результаті був вироблений новий SQL-інтерфейс, але API-інтерфейс залишився в спадок від mSQL. Звідки походить назва «MySQL» — достеменно не відомо. Розробники дають два варіанти: або тому, що практично всі напрацювання компанії починалися з префікса My, або на честь дівчинки на ім'я My, дочки Майкла Монті Віденіуса, одного з розробників системи[2].
                        </p>
                    </section>

                    <section>
                        <p>Поточна стабільна версія 5.6 (05.02.2013)</p>
                    </section>
                </section>

                <section>

                    <section>
                        <h2>Логінча архітектура MySql</h2>
                        <img src="img/mysql_architecture.png">
                    </section>

                    <section>
                        <h2>Оптимизация и выполнение</h2>
                        <p>MySQL осуществляет синтаксический разбор запросов для создания
                            внутренней структуры (дерева разбора), а затем выполняет ряд оптими-
                            заций. В их число входят переписывание запроса, определение порядка
                            чтения таб­
                            лиц, выбор используемых индексов и т. п. Вы можете повли-
                            ять на работу оптимизатора, включив в запрос специальные ключевые
                            слова-подсказки (hints). Также существует возможность попросить сер-
                            вер объяснить различные аспекты оптимизации. Это позволит вам по-
                            нять, какие решения принимает сервер, и даст отправную точку для из-
                            менения запросов, схем и настроек с целью достижения максимальной
                            эффективности работы. </p>
                    </section>

                    <section>
                        <p>Оптимизатор не интересуется тем, в  какой подсис­
                            теме хранения дан-
                            ных находится каждая таб­
                            лица, но подсис­
                            тема хранения данных вли-
                            яет на то, как сервер оптимизирует запрос. Оптимизатор запрашива-
                            ет подсис­
                            тему хранения данных о  некоторых ее возможностях и  стои-
                            мости определенных операций, а также о статистике по содержащимся
                            в  таб­
                            лицах данным. Например, некоторые подсис­
                            темы хранения под-
                            держивают типы индексов, которые могут быть полезными для вы-
                            полнения определенных запросов. Об индексировании и оптимизации
                            схем более подробно написано в третьей главе.</p>
                    </section>

                    <section>
                        <h2>Управление конкурентным доступом</h2>

                        <ul style="list-style: none;">
                            <li class="fragment">Блокировки чтения/записи (Также блокировки записи имеют более высокий при-
                                оритет, чем блокировки чтения, поэтому запрос блокировки записи бу-
                                дет помещен в очередь перед уже имеющимися запросами блокировки
                                чтения (блокировки записи могут отодвигать в очереди блокировки чте-
                                ния, но блокировки чтения не могут отодвигать блокировки записи).)</li>
                            <li class="fragment">Табличные блокировки (Например, для таких команд, как ALTER TABLE, сервер применяет таблич-
                                ную блокировку вне зависимости от подсистемы хранения данных.)</li>
                            <li class="fragment">Блокировки строк (InnoDB и Falcon)</li>
                        </ul>
                    </section>

                    <section>
                        <h2>Транзакции</h2>
                        <p>Транзакцией называется атомарная группа запросов SQL, т. е. которые рассматриваются как единое целое.</p>
                        START TRANSACTION;
                        <pre><code>
SELECT balance FROM checking WHERE customer_id = 10233276;
UPDATE checking SET balance = balance - 200.00 WHERE customer_id = 10233276;
UPDATE savings SET balance = balance + 200.00 WHERE customer_id = 10233276;
COMMIT;
                        </code></pre>
                        Транзакций недостаточно, если сис­
                        тема не проходит тест ACID. Аббре-
                        виатура ACID расшифровывается как Atomicity, Consistency, Isolation
                        и Durability (атомарность, непротиворечивость, изолированность и дол-
                        говечность).
                    </section>
                    <section>
                        <h2>Уровни изоляции</h2>
                        <ul style="list-style: none;">
                            <li class="fragment">READ UNCOMMITTED - транзакции могут видеть результаты незафиксированных транзакций</li>
                            <li class="fragment">READ COMMITTED - Уровнем изоляции по умолчанию для большинства СУБД (но не для MySQL!) транзакция увидит
                                только те изменения, которые были уже зафиксированы другими
                                транзакциями к моменту ее начала, а произведенные ею изменения
                                останутся невидимыми для других транзакций, пока текущая тран-
                                закция не будет зафиксирована.</li>
                            <li class="fragment">REPEATABLE READ Он гарантирует, что любые строки,
                                которые считываются в  контексте транзакции, будут «выглядеть
                                такими же» при последовательных операциях чтения в  пределах
                                одной и  той же транзакции, однако теоретически на этом уровне
                                возможен феномен фантомного чтения</li>
                            <li class="fragment">SERIALIZABLE В двух словах,
                                уровень SERIALIZABLE блокирует каждую строку, которую транзак-
                                ция читает. На этом уровне может возникать множество задержек
                                и  конфликтов при блокировках.</li>
                        </ul>
                        <pre><code>
[mysqld]
transaction-isolation = REPEATABLE-READ
                        </code></pre>
                    </section>

                    <section>
                        <h2>Взаимоблокировки</h2>
                        <pre><code>
Транзакция #1
START TRANSACTION;
UPDATE StockPrice SET close = 45.50 WHERE stock_id = 4 and date = ‘2002-05-01’;
UPDATE StockPrice SET close = 19.80 WHERE stock_id = 3 and date = ‘2002-05-02’;
COMMIT;
Транзакция #2
START TRANSACTION;
UPDATE StockPrice SET high = 20.12 WHERE stock_id = 3 and date = ‘2002-05-02’;
UPDATE StockPrice SET high = 47.20 WHERE stock_id = 4 and date = ‘2002-05-01’;
COMMIT;
                        </code></pre>
                        <p>Способом, которым InnoDB обрабатывает взаимоблокировки, является
                            откат той транзакции, которая захватила меньше всего монопольных
                            блокировок строк (приблизительный показатель легкости отката).</p>
                    </section>

                </section>

                <section>
                    <section>
                        <h2>Підсистеми зберігання в MySql</h2>
                    </section>

                    <section>
                        <h2>MyIsam</h2>
                        <ul style="list-style: none;">
                            <li class="fragment">Блокування на рівні таблиці. Підтримується можливість додавати нові рядки в момент, коли виконуюються запити на читання (конкурентні вставки)</li>
                            <li class="fragment">Підтримується повнотекстовий індекс.</li>
                            <li class="fragment">REPEATABLE READ Он гарантирует, что любые строки,
                                которые считываются в  контексте транзакции, будут «выглядеть
                                такими же» при последовательных операциях чтения в  пределах
                                одной и  той же транзакции, однако теоретически на этом уровне
                                возможен феномен фантомного чтения</li>
                            <li class="fragment">SERIALIZABLE В двух словах,
                                уровень SERIALIZABLE блокирует каждую строку, которую транзак-
                                ция читает. На этом уровне может возникать множество задержек
                                и  конфликтов при блокировках.</li>
                        </ul>
                    </section>

                    <section>
                        <h2>MyISAM Merge</h2>
                        <p>Подсис­
                            тема хранения Merge является вариацией на тему MyISAM. Таб­
                            лица типа Merge представляет собой объединение нескольких струк-
                            турно одинаковых таб­
                            лиц MyISAM в  одну виртуальную таб­
                            лицу. Это
                            особенно полезно, когда вы используете MySQL для протоколирования
                            и  организации хранилищ данных.</p>
                    </section>

                    <section>
                        <h2>Підсистема InnoDB</h2>
                    </section>

                    <section>
                        <h2>Подсистема Memory</h2>
                    </section>

                    <section>
                        <h2>Подсистема Archive</h2>
                    </section>

                    <section>
                        <h2>Подсистема CSV</h2>
                    </section>

                    <section>
                        <h2>Подсистема Blackhole</h2>
                    </section>

                    <section>
                        <h2>Подсистема NDB Cluster</h2>
                    </section>

                    <section>
                        <h2>Подсистема Maria</h2>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Пошук вузьких місць</h2>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Пошук вузьких місць</h2>
                    </section>

                    <section>
                        <h2>Еталонне тестування (benchmarking)</h2>
                        <p>Дозволяє виміряти продуктивність системи</p>

                        <h2>Профілювання (profiling)</h2>
                        <p>Дозволяє знайти місця де програма витрачає найбільше часу і споживає найбільше ресурсів</p>
                    </section>

                    <section>
                        <h3>Дві стратегії тестування</h3>
                        <p class="fragment"><strong>Повне</strong> - тестування програми загалом</p>
                        <p class="fragment"><strong>Компонентне</strong> - тестування конкретного компонента</p>
                    </section>

                    <section>
                        <h3>Інструменти повного тестування</h3>
                        <ul style="list-style: none;">
                            <li class="fragment"><strong><em><a target="_blank" href="http://httpd.apache.org/docs/2.2/programs/ab.html">ab</a></em></strong> - Показує скільки запитів в секунду здатет обслужити HTTP-сервер </li>
                            <li class="fragment"><strong><em><a target="_blank" href="http://www.acme.com/software/http_load/">http_load</a></em></strong> - Призначений для створення навантаження на сервер</li>
                            <li class="fragment"><strong><em><a target="_blank" href="http://jakarta.apache.org/jmeter/">JMeter</a></em></strong> - Потужніша альтернатива з графічним інтефейсом та гнучким налаштування емуляції користувачів</li>
                        </ul>
                    </section>

                    <section>
                        <h3>Інструменти компонентного тестування</h3>
                        <ul style="list-style: none;">
                            <li class="fragment"><strong><em><a target="_blank" href="http://dev.mysql.com/doc/refman/5.5/en/mysqlslap.html">mysqlslap</a></em></strong> - емулює навантаження на сервер і показує дані хронометража. Можна налаштувати кількість одночасних з'єднань та передати команди</li>
                            <li class="fragment"><strong><em><a target="_blank" href="http://sysbench.sourceforge.net">sysbench</a></em></strong> - Призначений для представлення продуктивності ОС</li>
                        </ul>
                    </section>

                    <section>
                        <h3>Профілювання MySQL</h3>
                    </section>

                    <section>
                        <h3>Ведення протоколу запитів</h3>
                        <pre><code>
#log_slow_queries < 5.5.24
slow_query_log_file     = /var/log/mysql/mysql-slow.log
slow_query_log          = 1
long_query_time         = 1
log-queries-not-using-indexes
                        </code></pre>
                    </section>

                    <section>
                        <h3>Приклад з логу повільних запитів</h3>
                        <pre><code>
# Time: 130508 12:25:33
# User@Host: root[root] @ localhost []  Id:    18
# Query_time: 2.464897  Lock_time: 0.000068 Rows_sent: 1000  Rows_examined: 1000
SET timestamp=1368005133;
SELECT * FROM cities ORDER BY `name` DESC LIMIT 1000;
                        </code></pre>
                    </section>

                    <section>
                        <h3>Інструменти аналізу логів</h3>
                        <ul style="list-style: none;">
                            <li class="fragment"><strong><em>mysqldumpslow</em></strong> - Показує скільки раз кожеш запит з'являється в журналі повільних запитів </li>
                            <li class="fragment"><strong><em><a target="_blank" href="http://www.mysqlperformanceblog.com/files/utils/mysql_slow_log_filter">mysql_slow_log_filter</a></em></strong> - Майже як попердній з додатковими параметрами: мінімальний поріг часу та кількість рядків
                            <pre><code>
tail -f mysql-slow.log | mysql_slow_log_filter -T 0.5 -R 1000
                            </code></pre></li>
                            <li class="fragment"><strong><em><a target="_blank" href="http://www.mysql­performanceblog.com/files/utils/mysql_slow_log_parser">mysql_slow_log_ parser</a></em></strong> - Створює звіт, показує min,max час, запит до якого можна застосувати EXPLAIN</li>
                        </ul>
                    </section>

                </section>

                <section>

                    <section>
                        <h2>Оптимізація запитів та індексування</h2>
                    </section>

                    <section>
                        <h2>Типи індексів</h2>
                        <ul style="list-style: none;">
                            <li class="fragment">B-Tree індекси</li>
                            <li class="fragment">Хеш-індекси</li>
                            <li class="fragment">Повнотекстові індекси (FULLTEXT)</li>
                        </ul>
                    </section>

                    <section>
                        <h2>B-Tree індекси</h2>
                        <p>Корисні лише в тому випадку коли використовується ліва частина ключа</p>
                        <ul>
                            <li class="fragment">Пошук по значенню ключа</li>
                            <li class="fragment">По діапазону ключів</li>
                            <li class="fragment">По префіксу ключа</li>
                        </ul>
                    </section>

                    <section>
                        <h2>Хеш-індекси</h2>
                        <p>Корисні лише для точного пошуку із використанням всіх стовбців індекса</p>
                        <p>Обмеження</p>
                        <ul>
                            <li class="fragment">Не використовується для сортування</li>
                            <li class="fragment">Не підтримує пошук по частині ключа</li>
                            <li class="fragment">Не підтримує пошук по діапазону</li>
                            <li class="fragment">При збільшенні колізій зменшується швидкість</li>
                        </ul>
                    </section>

                    <section>
                        <h2>Піддослідна база даних "Працівники"</h2>
                        <p>Структура</p>
                        <img src="img/employees.png" />
                        <img src="img/dep_emp.png" />
                        <img src="img/dep.png" />
                        <img src="img/dep_manager.png" />
                        <img src="img/salaries.png" />
                        <img src="img/titles.png" />
                    </section>

                    <section>
                        <h2>Ізоляція стовпця</h2>
                        <p>MySql не може використовувати індекс по стовпцю, якщо він не ізольований в запиті</p>
                        <pre><code>
SELECT first_name FROM employees WHERE emp_no + 1 = 11001;
SELECT first_name FROM employees WHERE emp_no = 11000;

SELECT first_name, hire_date FROM employees WHERE YEAR(CURRENT_DATE) - YEAR(hire_date) <= 14;
SELECT first_name, hire_date FROM employees WHERE hire_date >= DATE_SUB(CURRENT_DATE, INTERVAL 14 YEAR);
SELECT first_name, hire_date FROM employees WHERE hire_date >= DATE_SUB('2013-01-17', INTERVAL 14 YEAR);
                        </code></pre>
                    </section>

                    <section>
                        <h2>Explain</h2>
                        <img src="img/explain_2_6_1.png">
                        <img src="img/explain_2_6_2.png">
                    </section>

                    <section>
                        <h2>Індекси по декількох стовпцях</h2>
                        <pre><code>
SELECT last_name, first_name FROM salaries
LEFT JOIN employees USING(emp_no)
WHERE from_date = '1995-12-03' AND to_date = '1996-12-02'
                        </code></pre>
                    </section>

                    <section>
                        <h2>Багатоколоночні (окремі) індекси vs комбіновані індекси</h2>
                    </section>

                    <section>
                        <h2>Покриваючі індекси</h2>

                        індекс і сортування
                    </section>

                    <section>
                        <h2>Індекс і посторінкова навігація</h2>


                    </section>
                </section>

                <section>
                    <h2>Нормалізація і денормалізація</h2>
                </section>

                <section>
                    <h2>Реплікація</h2>
                </section>
			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
                width: 1200,
                minScale: 1,
                maxScale: 1.0,
				controls: true,
				progress: true,
				history: true,
				center: true,

				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/showdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
					// { src: 'plugin/search/search.js', async: true, condition: function() { return !!document.body.classList; } }
					// { src: 'plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

		</script>

	</body>
</html>
